(()=>{"use strict";console.log("Netflix Subtitle Downloader: Content script loaded");const e={"es-ES":"es","es-419":"es","es-MX":"es","es-AR":"es","pt-BR":"pt","pt-PT":"pt","en-US":"en","en-GB":"en","en-CA":"en","en-AU":"en","fr-FR":"fr","fr-CA":"fr","de-DE":"de","de-AT":"de","it-IT":"it","nl-NL":"nl","nl-BE":"nl","pl-PL":"pl","sv-SE":"sv","da-DK":"da","cs-CZ":"cs","ja-JP":"ja","ko-KR":"ko"};function t(t){return e[t]||t}let o=[],a=null;function l(e){window.postMessage({type:"NETFLIX_SUBTITLES_REQUEST",...e},window.location.origin)}chrome.runtime.onMessage.addListener(function(e,n,s){if(console.log("Netflix Subtitle Downloader: Received message from popup:",e),"checkNetflixPage"===e.action){const e=function(){const e=['h1[data-uia="hero-title"]',"h1.title",".title",'[data-uia="hero-title"]',"h1"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent&&e.textContent.trim())return e.textContent.trim()}const t=window.location.href.match(/\/watch\/(\d+)/);return t?`Netflix Video (ID: ${t[1]})`:"Unknown Title"}();console.log("Netflix Subtitle Downloader: Netflix page detected:",e),s({success:!0,isNetflixEpisode:!0,title:e,url:window.location.href})}else if("getSubtitles"===e.action)console.log("Netflix Subtitle Downloader: Requesting subtitles from page script"),l({action:"GET_TRACKS"}),s({success:!0,tracks:o,movieId:a||void 0});else if("downloadSubtitle"===e.action)console.log("Netflix Subtitle Downloader: Requesting subtitle download:",e.trackId),l({action:"DOWNLOAD_SUBTITLE",data:{trackId:e.trackId}}),s({success:!0,message:"Download request sent"});else if("processSmartSubtitles"===e.action)console.log("Smart Netflix Subtitles: Requesting subtitle processing:",e.settings),l({action:"processSmartSubtitles",settings:e.settings}),s({success:!0,message:"Smart subtitles processing started"});else if("getAvailableSubtitleTracks"===e.action){const e=o.map(e=>e.language).filter(Boolean).map(t);s({success:!0,availableLanguages:[...new Set(e)]})}else console.log("Netflix Subtitle Downloader: Unknown message action:",e.action),s({success:!1,error:"Unknown action"})}),window.addEventListener("message",function(e){if(new Set(["https://www.netflix.com","https://netflix.com"]).has(e.origin)&&e.source===window&&e.data&&"object"==typeof e.data&&"string"==typeof e.data.type)if("NETFLIX_SUBTITLES"===e.data.type)switch(console.log("Netflix Subtitle Downloader: Received message from page script:",e.data),e.data.action){case"TRACKS_AVAILABLE":o=e.data.data.tracks||[],a=e.data.data.movieId,console.log("Netflix Subtitle Downloader: Available tracks updated:",o);break;case"NO_TRACKS":o=[],console.log("Netflix Subtitle Downloader: No tracks available");break;case"DOWNLOAD_SUCCESS":console.log("Netflix Subtitle Downloader: Download successful:",e.data.data.filename);break;case"DOWNLOAD_ERROR":console.error("Netflix Subtitle Downloader: Download error:",e.data.data.error);break;case"SMART_SUBTITLES_SUCCESS":console.log("Smart Netflix Subtitles: Processing successful:",e.data.data);break;case"SMART_SUBTITLES_ERROR":console.error("Smart Netflix Subtitles: Processing error:",e.data.data.error)}else"NETFLIX_SUBTITLES_REQUEST"===e.data.type&&(console.log("Netflix Subtitle Downloader: Received request from page script:",e.data),"GET_CURRENT_STATE"===e.data.action&&(console.log("Netflix Subtitle Downloader: Getting current state from chrome.storage.local..."),chrome.storage.local.get(["smartSubtitlesEnabled","targetLanguage","nativeLanguage","vocabularyLevel"]).then(e=>{let t=!1,o=null;console.log("Netflix Subtitle Downloader: Storage result:",e),e.smartSubtitlesEnabled&&e.targetLanguage&&e.nativeLanguage&&e.vocabularyLevel&&(t=!0,o={enabled:!0,targetLanguage:e.targetLanguage,nativeLanguage:e.nativeLanguage,vocabularyLevel:e.vocabularyLevel}),console.log("Netflix Subtitle Downloader: Sending state response - enabled:",t,"settings:",o),window.postMessage({type:"NETFLIX_SUBTITLES_STATE_RESPONSE",data:{enabled:t,settings:o}},window.location.origin)}).catch(e=>{console.error("Netflix Subtitle Downloader: Failed to get state from storage:",e),window.postMessage({type:"NETFLIX_SUBTITLES_STATE_RESPONSE",data:{enabled:!1,settings:null}},window.location.origin)})))}),console.log("Netflix Subtitle Downloader: Injecting page script immediately"),function(){console.log("Netflix Subtitle Downloader: Injecting page script immediately");const e=document.createElement("script");e.src=chrome.runtime.getURL("page-script.js"),e.onload=function(){console.log("Netflix Subtitle Downloader: Page script loaded successfully"),e.remove()},e.onerror=function(){console.error("Netflix Subtitle Downloader: Failed to load page script")},document.head.insertBefore(e,document.head.firstChild)}(),console.log("Netflix Subtitle Downloader: Content script ready and listening for messages")})();