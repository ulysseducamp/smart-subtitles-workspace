(()=>{"use strict";console.log("Netflix Subtitle Downloader: Content script loaded");let e=[],t=null;function o(e){window.postMessage({type:"NETFLIX_SUBTITLES_REQUEST",...e},"*")}chrome.runtime.onMessage.addListener(function(a,l,n){if(console.log("Netflix Subtitle Downloader: Received message from popup:",a),"checkNetflixPage"===a.action){const e=function(){const e=['h1[data-uia="hero-title"]',"h1.title",".title",'[data-uia="hero-title"]',"h1"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent&&e.textContent.trim())return e.textContent.trim()}const t=window.location.href.match(/\/watch\/(\d+)/);return t?`Netflix Video (ID: ${t[1]})`:"Unknown Title"}();console.log("Netflix Subtitle Downloader: Netflix page detected:",e),n({success:!0,isNetflixEpisode:!0,title:e,url:window.location.href})}else"getSubtitles"===a.action?(console.log("Netflix Subtitle Downloader: Requesting subtitles from page script"),o({action:"GET_TRACKS"}),n({success:!0,tracks:e,movieId:t||void 0})):"downloadSubtitle"===a.action?(console.log("Netflix Subtitle Downloader: Requesting subtitle download:",a.trackId),o({action:"DOWNLOAD_SUBTITLE",data:{trackId:a.trackId}}),n({success:!0,message:"Download request sent"})):"processSmartSubtitles"===a.action?(console.log("Smart Netflix Subtitles: Requesting subtitle processing:",a.settings),o({action:"processSmartSubtitles",settings:a.settings}),n({success:!0,message:"Smart subtitles processing started"})):(console.log("Netflix Subtitle Downloader: Unknown message action:",a.action),n({success:!1,error:"Unknown action"}))}),window.addEventListener("message",function(o){if("NETFLIX_SUBTITLES"===o.data.type)switch(console.log("Netflix Subtitle Downloader: Received message from page script:",o.data),o.data.action){case"TRACKS_AVAILABLE":e=o.data.data.tracks||[],t=o.data.data.movieId,console.log("Netflix Subtitle Downloader: Available tracks updated:",e);break;case"NO_TRACKS":e=[],console.log("Netflix Subtitle Downloader: No tracks available");break;case"DOWNLOAD_SUCCESS":console.log("Netflix Subtitle Downloader: Download successful:",o.data.data.filename);break;case"DOWNLOAD_ERROR":console.error("Netflix Subtitle Downloader: Download error:",o.data.data.error);break;case"SMART_SUBTITLES_SUCCESS":console.log("Smart Netflix Subtitles: Processing successful:",o.data.data);break;case"SMART_SUBTITLES_ERROR":console.error("Smart Netflix Subtitles: Processing error:",o.data.data.error)}else"NETFLIX_SUBTITLES_REQUEST"===o.data.type&&(console.log("Netflix Subtitle Downloader: Received request from page script:",o.data),"GET_CURRENT_STATE"===o.data.action&&(console.log("Netflix Subtitle Downloader: Getting current state from chrome.storage.local..."),chrome.storage.local.get(["smartSubtitlesEnabled","targetLanguage","nativeLanguage","vocabularyLevel"]).then(e=>{let t=!1,o=null;console.log("Netflix Subtitle Downloader: Storage result:",e),e.smartSubtitlesEnabled&&e.targetLanguage&&e.nativeLanguage&&e.vocabularyLevel&&(t=!0,o={enabled:!0,targetLanguage:e.targetLanguage,nativeLanguage:e.nativeLanguage,vocabularyLevel:e.vocabularyLevel}),console.log("Netflix Subtitle Downloader: Sending state response - enabled:",t,"settings:",o),window.postMessage({type:"NETFLIX_SUBTITLES_STATE_RESPONSE",data:{enabled:t,settings:o}},"*")}).catch(e=>{console.error("Netflix Subtitle Downloader: Failed to get state from storage:",e),window.postMessage({type:"NETFLIX_SUBTITLES_STATE_RESPONSE",data:{enabled:!1,settings:null}},"*")})))}),console.log("Netflix Subtitle Downloader: Injecting page script immediately"),function(){console.log("Netflix Subtitle Downloader: Injecting page script immediately");const e=document.createElement("script");e.src=chrome.runtime.getURL("page-script.js"),e.onload=function(){console.log("Netflix Subtitle Downloader: Page script loaded successfully"),e.remove()},e.onerror=function(){console.error("Netflix Subtitle Downloader: Failed to load page script")},document.head.insertBefore(e,document.head.firstChild)}(),console.log("Netflix Subtitle Downloader: Content script ready and listening for messages")})();