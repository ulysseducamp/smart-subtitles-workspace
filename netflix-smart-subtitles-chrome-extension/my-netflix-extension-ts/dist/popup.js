(()=>{"use strict";console.log("Smart Netflix Subtitles: Popup script loaded");const e="smartSubtitlesEnabled",t="targetLanguage",a="nativeLanguage",n="vocabularyLevel",o={en:"English",fr:"French",es:"Spanish",de:"German",it:"Italian",pt:"Portuguese","pt-BR":"Portuguese (Brazil)",pl:"Polish",nl:"Dutch",sv:"Swedish",da:"Danish",cs:"Czech",ja:"Japanese",ko:"Korean"},l=document.getElementById("smart-subtitles-toggle"),s=document.getElementById("target-language"),r=document.getElementById("native-language"),i=document.getElementById("vocabulary-level"),c=document.getElementById("process-btn"),u=document.getElementById("status-message"),d=document.getElementById("loading-indicator"),g=document.getElementById("subtitle-select"),b=document.getElementById("download-btn");document.getElementById("legacy-section");let f={enabled:!1,targetLanguage:"",nativeLanguage:"",vocabularyLevel:0},m=!1;async function v(){try{const o={[e]:f.enabled,[t]:f.targetLanguage,[a]:f.nativeLanguage,[n]:f.vocabularyLevel};await chrome.storage.local.set(o),console.log("Smart Netflix Subtitles: Settings saved to storage:",o)}catch(e){console.error("Smart Netflix Subtitles: Error saving settings:",e)}}function S(e,t="info"){u.textContent=e,u.className=`status ${t}`,console.log("Smart Netflix Subtitles: Status:",e)}function y(){u.textContent="",u.className="status"}function h(){d.style.display="none",c.disabled=!1,c.textContent="Process Subtitles"}function L(){const e=l.checked;s.disabled=!e,r.disabled=!e,i.disabled=!e,c.disabled=!e||m,f.enabled=e,v(),e||(y(),h())}function x(e){r.innerHTML='<option value="">Select a language</option>';const t=[];Object.keys(o).forEach(a=>{const n=e.includes(a);t.push({code:a,name:o[a],available:n})}),t.sort((e,t)=>e.name.localeCompare(t.name)),t.forEach(e=>{const t=document.createElement("option");t.value=e.code,t.textContent=e.available?e.name:`${e.name} (Undetected)`,t.disabled=!e.available,e.available||(t.style.color="#999",t.style.fontStyle="italic"),r.appendChild(t)})}function N(){const e=f.enabled&&f.targetLanguage&&f.nativeLanguage&&f.vocabularyLevel&&f.targetLanguage!==f.nativeLanguage&&!m;c.disabled=!e}function E(){f.targetLanguage=s.value,f.nativeLanguage=r.value,v(),N(),f.targetLanguage&&f.nativeLanguage&&y()}function p(){f.vocabularyLevel=parseInt(i.value)||0,v(),N(),f.vocabularyLevel&&y()}async function w(){if(console.log("Smart Netflix Subtitles: Processing subtitles with settings:",f),f.enabled&&!(f.targetLanguage?f.nativeLanguage?f.targetLanguage===f.nativeLanguage?(S("Target and native languages must be different","error"),1):!f.vocabularyLevel&&(S("Please select a vocabulary level","error"),1):(S("Please select a native language","error"),1):(S("Please select a target language","error"),1))&&!m){m=!0,d.style.display="flex",c.disabled=!0,c.textContent="Processing...",y();try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)throw new Error("No active tab found");if(!e.url||!e.url.includes("netflix.com"))throw new Error("Please navigate to Netflix first");const t=await chrome.tabs.sendMessage(e.id,{action:"processSmartSubtitles",settings:f});if(console.log("Smart Netflix Subtitles: Processing response:",t),!t||!t.success)throw new Error(t?.error||"Failed to process subtitles");S("Smart subtitles processed successfully!","success")}catch(e){console.error("Smart Netflix Subtitles: Error processing subtitles:",e),S(`Error: ${e instanceof Error?e.message:"Unknown error occurred"}`,"error")}finally{m=!1,h()}}}function k(){l.disabled=!0,s.disabled=!0,r.disabled=!0,i.disabled=!0,c.disabled=!0,g.disabled=!0,b.disabled=!0}async function P(){console.log("Smart Netflix Subtitles: Download button clicked");const e=g.value;if(e){console.log("Smart Netflix Subtitles: Downloading subtitle track:",e),S("Downloading subtitle...","info");try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t)return void S("No active tab found","error");const a=await chrome.tabs.sendMessage(t.id,{action:"downloadSubtitle",trackId:e});console.log("Smart Netflix Subtitles: Download response:",a),a&&a.success?S("Download started!","success"):S("Error starting download","error")}catch(e){console.error("Smart Netflix Subtitles: Error downloading subtitle:",e),S("Error downloading subtitle: "+(e instanceof Error?e.message:"Unknown error"),"error")}}else S("Please select a subtitle first","error")}async function I(){console.log("Smart Netflix Subtitles: Initializing popup..."),k(),y(),h(),await async function(){try{const o=await chrome.storage.local.get([e,t,a,n]);console.log("Smart Netflix Subtitles: Loaded settings from storage:",o),!(o[e]||o[t]||o[a]||o[n])&&console.log("Smart Netflix Subtitles: First launch detected - using default disabled state"),f.enabled=o[e]||!1,f.targetLanguage=o[t]||"",f.nativeLanguage=o[a]||"",f.vocabularyLevel=o[n]||0,l.checked=f.enabled,s.value=f.targetLanguage,r.value=f.nativeLanguage,i.value=f.vocabularyLevel.toString(),console.log("Smart Netflix Subtitles: Settings loaded and UI updated:",f)}catch(e){console.error("Smart Netflix Subtitles: Error loading settings:",e)}}(),await async function(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void console.log("Smart Netflix Subtitles: No active tab found for language detection");if(!e.url?.includes("netflix.com"))return console.log("Smart Netflix Subtitles: Not on Netflix page, using default languages"),void x([]);const t=await chrome.tabs.sendMessage(e.id,{action:"getAvailableSubtitleTracks"});t&&t.success&&t.availableLanguages?x(t.availableLanguages):(console.log("Smart Netflix Subtitles: No subtitle tracks found, using default languages"),x([]))}catch(e){console.error("Smart Netflix Subtitles: Error loading available languages:",e),x([])}}(),L(),async function(){console.log("Smart Netflix Subtitles: Checking if on Netflix episode page...");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void S("No active tab found","error");if(console.log("Smart Netflix Subtitles: Active tab URL:",e.url),!e.url||!e.url.includes("netflix.com"))return S("Please navigate to Netflix to use Smart Subtitles","error"),void k();const t=await chrome.tabs.sendMessage(e.id,{action:"checkNetflixPage"});console.log("Smart Netflix Subtitles: Content script response:",t),t&&t.success?t.isNetflixEpisode?(S(`Ready: ${t.title}`,"success"),l.disabled=!1,L()):(S("Please navigate to a Netflix episode or movie","error"),k()):(S("Error checking Netflix page","error"),k())}catch(e){console.error("Smart Netflix Subtitles: Error checking Netflix page:",e);const t=e instanceof Error?e.message:"Unknown error";t.includes("Could not establish connection")?S("Please refresh the Netflix page and try again","error"):S("Error: "+t,"error"),k()}}(),l.addEventListener("change",L),s.addEventListener("change",E),r.addEventListener("change",E),i.addEventListener("change",p),c.addEventListener("click",w),b.addEventListener("click",P),g.addEventListener("change",function(){const e=this.value;b.disabled=!e}),console.log("Smart Netflix Subtitles: Popup initialized with loaded settings")}document.addEventListener("DOMContentLoaded",I),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",I):I()})();