<!DOCTYPE html>
<!--
 * Netflix Subtitle Downloader
 * Copyright (C) 2025 Based on Subadub by Russel Simmons
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflix Subtitle Injection Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #333;
            border: 2px solid #666;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-placeholder {
            font-size: 24px;
            text-align: center;
        }
        .test-info {
            background: #222;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .test-info h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .test-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-info li {
            margin: 5px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.info {
            background: #2196F3;
            color: white;
        }
        .status.warning {
            background: #FF9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Netflix Subtitle Injection Test</h1>
        
        <div class="test-info">
            <h3>Test Overview</h3>
            <p>This page simulates the Netflix video player environment to test subtitle injection functionality.</p>
            <ul>
                <li><strong>Test WebVTT Content:</strong> "This is a test subtitle" (repeating every 5 seconds)</li>
                <li><strong>Injection Method:</strong> Track element injection with custom overlay</li>
                <li><strong>Styling:</strong> Bottom center, white text, black background</li>
                <li><strong>Controls:</strong> Press 'S' key to toggle subtitle visibility</li>
            </ul>
        </div>

        <div class="status info">
            <strong>Status:</strong> Ready to test subtitle injection
        </div>

        <!-- Simulated Netflix video player container -->
        <div class="video-container watch-video">
            <div class="video-placeholder">
                <div>ðŸŽ¬ Simulated Netflix Video Player</div>
                <div style="font-size: 16px; margin-top: 10px; color: #ccc;">
                    Video would be playing here<br>
                    Subtitles should appear below
                </div>
            </div>
            
            <!-- Video element for track injection -->
            <video id="test-video" style="display: none;">
                <source src="data:video/mp4;base64," type="video/mp4">
            </video>
        </div>

        <div class="test-info">
            <h3>Expected Behavior</h3>
            <ul>
                <li>Test subtitle should appear at bottom center of video area</li>
                <li>Subtitle should show "This is a test subtitle" every 5 seconds</li>
                <li>Subtitle should have black background with white text</li>
                <li>Pressing 'S' should toggle subtitle visibility</li>
                <li>Console should show injection logs</li>
            </ul>
        </div>

        <div class="test-info">
            <h3>Testing Instructions</h3>
            <ol>
                <li>Load this page in a browser</li>
                <li>Open browser console to see injection logs</li>
                <li>Look for test subtitle appearing in the video area</li>
                <li>Press 'S' key to toggle subtitle visibility</li>
                <li>Verify subtitle timing and positioning</li>
            </ol>
        </div>

        <div class="status warning">
            <strong>Note:</strong> This is a test environment. The actual extension will inject into real Netflix pages.
        </div>
    </div>

    <script>
        // Simulate the injection functionality for testing
        console.log('Netflix Subtitle Injection Test: Starting test environment');
        
        // Test WebVTT content
        const TEST_WEBVTT_CONTENT = `WEBVTT

00:00:00.000 --> 00:00:05.000
This is a test subtitle

00:00:05.000 --> 00:00:10.000
This is a test subtitle

00:00:10.000 --> 00:00:15.000
This is a test subtitle

00:00:15.000 --> 00:00:20.000
This is a test subtitle

00:00:20.000 --> 00:00:25.000
This is a test subtitle`;

        // Injection constants
        const TRACK_ELEM_ID = 'netflix-subtitle-track';
        const CUSTOM_SUBS_ELEM_ID = 'netflix-custom-subs';
        
        let showSubsState = true;

        // Function to create and inject track element
        function addTrackElem(videoElem, blob, srclang) {
            console.log('Test: Adding track element for injection');
            
            const trackElem = document.createElement('track');
            trackElem.id = TRACK_ELEM_ID;
            trackElem.src = URL.createObjectURL(blob);
            trackElem.kind = 'subtitles';
            trackElem.default = true;
            trackElem.srclang = srclang;
            videoElem.appendChild(trackElem);
            trackElem.track.mode = 'hidden';

            trackElem.addEventListener('load', function() {
                console.log('Test: Track loaded successfully');
            }, false);

            // Create custom subtitle overlay div
            const customSubsElem = document.createElement('div');
            customSubsElem.id = CUSTOM_SUBS_ELEM_ID;
            customSubsElem.style.cssText = 'position: absolute; bottom: 20vh; left: 0; right: 0; color: white; font-size: 3vw; text-align: center; user-select: text; -moz-user-select: text; z-index: 100; pointer-events: none';

            // Handle cue changes for real-time subtitle display
            trackElem.addEventListener('cuechange', function(e) {
                // Remove all children
                while (customSubsElem.firstChild) {
                    customSubsElem.removeChild(customSubsElem.firstChild);
                }

                const track = e.target;
                console.log('Test: Active cues:', track.track?.activeCues);
                
                if (track.track?.activeCues) {
                    for (const cue of track.track.activeCues) {
                        const cueElem = document.createElement('div');
                        cueElem.style.cssText = 'background: rgba(0,0,0,0.8); white-space: pre-wrap; padding: 0.2em 0.3em; margin: 10px auto; width: fit-content; width: -moz-fit-content; pointer-events: auto';
                        cueElem.innerHTML = cue.text;
                        customSubsElem.appendChild(cueElem);
                    }
                }
            }, false);

            // Append overlay to the player
            const playerElem = document.querySelector('.watch-video');
            if (playerElem) {
                playerElem.appendChild(customSubsElem);
                console.log('Test: Track element and overlay added successfully');
            }
        }

        // Function to update subtitle display visibility
        function updateSubtitleDisplay() {
            const subsElem = document.getElementById(CUSTOM_SUBS_ELEM_ID);
            if (subsElem) {
                if (showSubsState) {
                    subsElem.style.visibility = 'visible';
                } else {
                    subsElem.style.visibility = 'hidden';
                }
            }
        }

        // Initialize test
        function initializeTest() {
            console.log('Test: Initializing subtitle injection test');
            
            const videoElem = document.getElementById('test-video');
            if (videoElem) {
                const testBlob = new Blob([TEST_WEBVTT_CONTENT], { type: 'text/vtt' });
                addTrackElem(videoElem, testBlob, 'en');
            }

            // Set up keyboard shortcuts
            document.body.addEventListener('keydown', function(e) {
                if ((e.keyCode === 83) && !e.altKey && !e.ctrlKey && !e.metaKey) { // unmodified S key
                    console.log('Test: Toggle subtitle display');
                    showSubsState = !showSubsState;
                    updateSubtitleDisplay();
                }
            }, false);
            
            console.log('Test: Subtitle injection test initialized');
            console.log('Test: Press "S" key to toggle subtitle visibility');
        }

        // Start test when page loads
        window.addEventListener('load', initializeTest);
    </script>
</body>
</html>
