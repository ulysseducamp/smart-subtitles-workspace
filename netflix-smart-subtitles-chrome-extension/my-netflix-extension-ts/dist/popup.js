(()=>{"use strict";console.log("Smart Netflix Subtitles: Popup script loaded");const e="smartSubtitlesEnabled",t="targetLanguage",a="nativeLanguage",n="vocabularyLevel",o=document.getElementById("smart-subtitles-toggle"),s=document.getElementById("target-language"),r=document.getElementById("native-language"),l=document.getElementById("vocabulary-level"),i=document.getElementById("process-btn"),c=document.getElementById("status-message"),d=document.getElementById("loading-indicator"),u=document.getElementById("subtitle-select"),g=document.getElementById("download-btn");document.getElementById("legacy-section");let b={enabled:!1,targetLanguage:"",nativeLanguage:"",vocabularyLevel:0},f=!1;async function v(){try{const o={[e]:b.enabled,[t]:b.targetLanguage,[a]:b.nativeLanguage,[n]:b.vocabularyLevel};await chrome.storage.local.set(o),console.log("Smart Netflix Subtitles: Settings saved to storage:",o)}catch(e){console.error("Smart Netflix Subtitles: Error saving settings:",e)}}function m(e,t="info"){c.textContent=e,c.className=`status ${t}`,console.log("Smart Netflix Subtitles: Status:",e)}function S(){c.textContent="",c.className="status"}function y(){d.style.display="none",i.disabled=!1,i.textContent="Process Subtitles"}function L(){const e=o.checked;s.disabled=!e,r.disabled=!e,l.disabled=!e,i.disabled=!e||f,b.enabled=e,v(),e||(S(),y())}function x(){const e=b.enabled&&b.targetLanguage&&b.nativeLanguage&&b.vocabularyLevel&&b.targetLanguage!==b.nativeLanguage&&!f;i.disabled=!e}function E(){b.targetLanguage=s.value,b.nativeLanguage=r.value,v(),x(),b.targetLanguage&&b.nativeLanguage&&S()}function N(){b.vocabularyLevel=parseInt(l.value)||0,v(),x(),b.vocabularyLevel&&S()}async function h(){if(console.log("Smart Netflix Subtitles: Processing subtitles with settings:",b),b.enabled&&!(b.targetLanguage?b.nativeLanguage?b.targetLanguage===b.nativeLanguage?(m("Target and native languages must be different","error"),1):!b.vocabularyLevel&&(m("Please select a vocabulary level","error"),1):(m("Please select a native language","error"),1):(m("Please select a target language","error"),1))&&!f){f=!0,d.style.display="flex",i.disabled=!0,i.textContent="Processing...",S();try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)throw new Error("No active tab found");if(!e.url||!e.url.includes("netflix.com"))throw new Error("Please navigate to Netflix first");const t=await chrome.tabs.sendMessage(e.id,{action:"processSmartSubtitles",settings:b});if(console.log("Smart Netflix Subtitles: Processing response:",t),!t||!t.success)throw new Error(t?.error||"Failed to process subtitles");m("Smart subtitles processed successfully!","success")}catch(e){console.error("Smart Netflix Subtitles: Error processing subtitles:",e),m(`Error: ${e instanceof Error?e.message:"Unknown error occurred"}`,"error")}finally{f=!1,y()}}}function w(){o.disabled=!0,s.disabled=!0,r.disabled=!0,l.disabled=!0,i.disabled=!0,u.disabled=!0,g.disabled=!0}async function p(){console.log("Smart Netflix Subtitles: Download button clicked");const e=u.value;if(e){console.log("Smart Netflix Subtitles: Downloading subtitle track:",e),m("Downloading subtitle...","info");try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t)return void m("No active tab found","error");const a=await chrome.tabs.sendMessage(t.id,{action:"downloadSubtitle",trackId:e});console.log("Smart Netflix Subtitles: Download response:",a),a&&a.success?m("Download started!","success"):m("Error starting download","error")}catch(e){console.error("Smart Netflix Subtitles: Error downloading subtitle:",e),m("Error downloading subtitle: "+(e instanceof Error?e.message:"Unknown error"),"error")}}else m("Please select a subtitle first","error")}async function P(){console.log("Smart Netflix Subtitles: Initializing popup..."),w(),S(),y(),await async function(){try{const i=await chrome.storage.local.get([e,t,a,n]);console.log("Smart Netflix Subtitles: Loaded settings from storage:",i),!(i[e]||i[t]||i[a]||i[n])&&console.log("Smart Netflix Subtitles: First launch detected - using default disabled state"),b.enabled=i[e]||!1,b.targetLanguage=i[t]||"",b.nativeLanguage=i[a]||"",b.vocabularyLevel=i[n]||0,o.checked=b.enabled,s.value=b.targetLanguage,r.value=b.nativeLanguage,l.value=b.vocabularyLevel.toString(),console.log("Smart Netflix Subtitles: Settings loaded and UI updated:",b)}catch(e){console.error("Smart Netflix Subtitles: Error loading settings:",e)}}(),L(),async function(){console.log("Smart Netflix Subtitles: Checking if on Netflix episode page...");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void m("No active tab found","error");if(console.log("Smart Netflix Subtitles: Active tab URL:",e.url),!e.url||!e.url.includes("netflix.com"))return m("Please navigate to Netflix to use Smart Subtitles","error"),void w();const t=await chrome.tabs.sendMessage(e.id,{action:"checkNetflixPage"});console.log("Smart Netflix Subtitles: Content script response:",t),t&&t.success?t.isNetflixEpisode?(m(`Ready: ${t.title}`,"success"),o.disabled=!1,L()):(m("Please navigate to a Netflix episode or movie","error"),w()):(m("Error checking Netflix page","error"),w())}catch(e){console.error("Smart Netflix Subtitles: Error checking Netflix page:",e);const t=e instanceof Error?e.message:"Unknown error";t.includes("Could not establish connection")?m("Please refresh the Netflix page and try again","error"):m("Error: "+t,"error"),w()}}(),o.addEventListener("change",L),s.addEventListener("change",E),r.addEventListener("change",E),l.addEventListener("change",N),i.addEventListener("click",h),g.addEventListener("click",p),u.addEventListener("change",function(){const e=this.value;g.disabled=!e}),console.log("Smart Netflix Subtitles: Popup initialized with loaded settings")}document.addEventListener("DOMContentLoaded",P),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P()})();