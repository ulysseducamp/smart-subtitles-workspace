(()=>{"use strict";class e{constructor(){this.baseUrl="https://smartsub-api-production.up.railway.app",this.proxyEndpoint="/proxy-railway",this.timeout=24e4}static getInstance(){return e.instance||(e.instance=new e),e.instance}async processSubtitles(e,t,o){if(console.log("Railway API Client: Processing subtitles with settings:",o),!e||!t)throw new Error("Missing required subtitle data");const n={"pt-BR":"pt","pt-br":"pt",pt_br:"pt"},l={target_srt:e,native_srt:t,target_language:n[o.targetLanguage]||o.targetLanguage,native_language:n[o.nativeLanguage]||o.nativeLanguage,top_n_words:o.vocabularyLevel,enable_inline_translation:!0},r=`${this.baseUrl}${this.proxyEndpoint}`;try{console.log("Railway API Client: Sending request to proxy:",r);const o=new FormData;o.append("target_srt",new Blob([e],{type:"text/plain"}),"target.srt"),o.append("native_srt",new Blob([t],{type:"text/plain"}),"native.srt"),o.append("target_language",l.target_language),o.append("native_language",l.native_language),o.append("top_n_words",l.top_n_words.toString());const n=new AbortController,a=setTimeout(()=>n.abort(),this.timeout),i=await fetch(r,{method:"POST",body:o,signal:n.signal});if(clearTimeout(a),console.log("Railway API Client: Response status:",i.status),!i.ok){const e=await i.text();throw console.error("Railway API Client: API error:",e),401===i.status?new Error("Invalid API key"):400===i.status?new Error("Invalid request data"):500===i.status?new Error("Server error occurred"):new Error(`API request failed: ${i.status} ${i.statusText}`)}const s=await i.json();if(console.log("Railway API Client: Processing result:",s),!s.success)throw new Error(s.error||"Unknown API error");return s}catch(e){if(console.error("Railway API Client: Request failed:",e),e instanceof Error){if("AbortError"===e.name)throw new Error("Request timeout - API took too long to respond");throw e}throw new Error("Network error occurred")}}async testConnection(){try{const e=`${this.baseUrl}/health`,t=new AbortController,o=setTimeout(()=>t.abort(),5e3),n=await fetch(e,{method:"GET",signal:t.signal});return clearTimeout(o),n.ok}catch(e){return console.error("Railway API Client: Connection test failed:",e),!1}}getConfigInfo(){return{baseUrl:this.baseUrl,hasApiKey:!0,endpoint:this.proxyEndpoint}}}const t=e.getInstance();!function(){console.log("Netflix Subtitle Downloader: Page script loaded - starting JSON hijacking immediately");const e="webvtt-lssdh-ios8",o="netflix-subtitle-track",n="netflix-custom-subs",l=["heaac-2-dash","heaac-2hq-dash","playready-h264mpl30-dash","playready-h264mpl31-dash","playready-h264hpl30-dash","playready-h264hpl31-dash","vp9-profile0-L30-dash-cenc","vp9-profile0-L31-dash-cenc","dfxp-ls-sdh","simplesdh","nflx-cmisc","BIF240","BIF320"],r=new Map,a=new Map;let i=null,s=null,c=null,u=!1,d=null,g=!1,f=new Map;function S(e){for(const t in e){const o=e[t];if(Array.isArray(o)&&("profiles"===t||o.some(e=>l.includes(e))))return o;if("object"==typeof o&&null!==o){const e=S(o);if(e)return e}}return null}function b(t){const o=t.movieId;console.log("Netflix Subtitle Downloader: Extracting tracks for movie ID:",o),i=o,i||(s=null);const n=[];if(t.timedtexttracks){console.log("Netflix Subtitle Downloader: Found timedtexttracks:",t.timedtexttracks);for(const o of t.timedtexttracks){if(console.log("Netflix Subtitle Downloader: Processing track:",o.language),o.isForcedNarrative||o.isNoneTrack){console.log("Netflix Subtitle Downloader: Skipping forced/none track");continue}if(!o.ttDownloadables){console.log("Netflix Subtitle Downloader: No ttDownloadables found");continue}const t=o.ttDownloadables[e];if(console.log("Netflix Subtitle Downloader: WebVTT downloadable:",t),!t||!t.urls){console.log("Netflix Subtitle Downloader: No WebVTT URLs found");continue}const l=t.urls[0].url;if(!l){console.log("Netflix Subtitle Downloader: No valid URL found");continue}const r="closedcaptions"===o.rawTrackType;n.push({id:o.new_track_id,language:o.language,languageDescription:o.languageDescription,bestUrl:l,isClosedCaptions:r})}if(console.log("Netflix Subtitle Downloader: Caching movie tracks:",o,n),r.set(o,n),h({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:o,tracks:n}}),console.log("Netflix Subtitle Downloader: Triggering subtitle injection after track discovery"),T(),n.length>0){console.log("Smart Netflix Subtitles: Requesting current state for auto-processing...");const e=async(t=0)=>{try{const{enabled:e,settings:t}=await async function(){return new Promise(e=>{const t=setTimeout(()=>{console.log("Smart Netflix Subtitles: State request timeout - assuming disabled"),e({enabled:!1,settings:null})},2e3),o=n=>{"NETFLIX_SUBTITLES_STATE_RESPONSE"===n.data.type&&(clearTimeout(t),window.removeEventListener("message",o),console.log("Smart Netflix Subtitles: Received state response:",n.data.data),e(n.data.data))};window.addEventListener("message",o),console.log("Smart Netflix Subtitles: Requesting current state from content script..."),h({type:"NETFLIX_SUBTITLES_REQUEST",action:"GET_CURRENT_STATE"})})}();e&&t?(console.log("Smart Netflix Subtitles: Auto-processing subtitles for movie ID:",o),await E(t)):(console.log("Smart Netflix Subtitles: Extension disabled or no settings, skipping auto-processing"),console.log("Smart Netflix Subtitles: State received - enabled:",e,"settings:",t))}catch(o){console.error("Smart Netflix Subtitles: Failed to get current state:",o),t<2?(console.log(`Smart Netflix Subtitles: Retrying state request (${t+1}/2)...`),setTimeout(()=>e(t+1),1e3*(t+1))):console.log("Smart Netflix Subtitles: Max retries reached, skipping auto-processing")}};e()}}else console.log("Netflix Subtitle Downloader: No timedtexttracks found")}const p=RegExp("</?([^>]*)>","ig");function m(e,t=!0){let o=e;if(o=o.replace(p,function(e,t){return["i","u","b"].includes(t.toLowerCase())?e:""}),t){const e=o.split("\n"),t=[];for(const o of e)o.startsWith("&lrm;")?t.push("‪"+o.slice(5)+"‬"):o.startsWith("&rlm;")?t.push("‫"+o.slice(5)+"‬"):t.push(o);o=t.join("\n")}return o}function w(e){const t=new Date(0,0,0,0,0,0,1e3*e);return t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")+":"+t.getSeconds().toString().padStart(2,"0")+","+t.getMilliseconds().toString().padStart(3,"0")}function y(e){return new Promise((t,o)=>{const n=document.createElement("video"),l=document.createElement("track");l.kind="subtitles",l.default=!0,n.appendChild(l);const r=URL.createObjectURL(e);l.src=r,l.addEventListener("load",function(){try{const e=[];let o=1;for(const t of l.track.cues){const n=m(t.text,!0);e.push(o+"\n"+w(t.startTime)+" --\x3e "+w(t.endTime)+"\n"+n+"\n\n"),o++}URL.revokeObjectURL(r),n.remove(),t(e.join(""))}catch(e){URL.revokeObjectURL(r),n.remove(),o(e)}},!1),l.addEventListener("error",function(){URL.revokeObjectURL(r),n.remove(),o(new Error("Failed to load WebVTT track"))},!1)})}function h(e){window.postMessage(e,"*")}function v(e,t,l,r=!1){console.log("Netflix Subtitle Downloader: Adding track element for injection"),x();const a=document.createElement("track");a.id=o,c=URL.createObjectURL(t),a.src=c,a.kind="subtitles",a.default=!0,a.srclang=l,e.appendChild(a),a.track.mode="hidden",a.addEventListener("load",function(){console.log("Netflix Subtitle Downloader: Track loaded successfully")},!1);const i=document.createElement("div");i.id=n;const s=r?"#4CAF50":"white";i.style.cssText=`position: absolute; bottom: 20vh; left: 0; right: 0; color: ${s}; font-size: 3vw; text-align: center; user-select: text; -moz-user-select: text; z-index: 100; pointer-events: none`,a.addEventListener("cuechange",function(e){for(;i.firstChild;)i.removeChild(i.firstChild);const t=e.target;if(console.log("Netflix Subtitle Downloader: Active cues:",t.track?.activeCues),t.track?.activeCues)for(const e of t.track.activeCues){const t=document.createElement("div");t.style.cssText="background: rgba(0,0,0,0.8); white-space: pre-wrap; padding: 0.2em 0.3em; margin: 10px auto; width: fit-content; width: -moz-fit-content; pointer-events: auto",t.innerHTML=m(e.text,!0),i.appendChild(t)}},!1);let u=document.querySelector(".watch-video");if(u||(u=document.querySelector('[data-uia="video-player"]')),u||(u=document.querySelector(".VideoPlayer")),u||(u=document.querySelector(".player-container")),u||(u=document.querySelector('[data-testid="video-player"]')),u||(u=document.querySelector(".netflix-player")),!u){const e=document.querySelectorAll('[class*="video"], [class*="player"]');for(const t of e){const e=t.className.toLowerCase();if(!e.includes("billboard")&&!e.includes("trailer")&&!e.includes("preview")){u=t;break}}}if(!u)return console.error("Netflix Subtitle Downloader: Could not find player element to append subtitles to"),void console.log("Netflix Subtitle Downloader: Available video-related elements:",{watchVideo:document.querySelector(".watch-video"),videoPlayer:document.querySelector('[data-uia="video-player"]'),videoPlayerClass:document.querySelector(".VideoPlayer"),playerContainer:document.querySelector(".player-container"),testIdPlayer:document.querySelector('[data-testid="video-player"]'),netflixPlayer:document.querySelector(".netflix-player"),videoElements:document.querySelectorAll('[class*="video"]'),playerElements:document.querySelectorAll('[class*="player"]'),watchElements:document.querySelectorAll('[class*="watch"]')});console.log("Netflix Subtitle Downloader: Found player element:",u),u.appendChild(i),console.log("Netflix Subtitle Downloader: Track element and overlay added successfully")}function x(){c&&(URL.revokeObjectURL(c),c=null);const e=document.getElementById(o);e&&e.remove();const t=document.getElementById(n);t&&t.remove()}function N(e){const t=e.split("\n");let o="WEBVTT\n\n";for(let e=0;e<t.length;e++){const n=t[e].trim();if(n&&!/^\d+$/.test(n)&&n.includes("--\x3e")){for(o+=n.replace(/,/g,".")+"\n";++e<t.length&&t[e].trim();)o+=t[e].trim()+"\n";o+="\n"}}return o}function T(){const e=document.querySelector("video");if(e&&i){const t=r.get(i);if(t&&t.length>0){const o=t[0],n=`${i}/${o.id}`;if(a.has(n)){const t=a.get(n);console.log("Netflix Subtitle Downloader: Using cached subtitle blob for injection"),null===c?(console.log("Netflix Subtitle Downloader: Updating subtitle injection - new blob detected"),v(e,t,o.language)):console.log("Netflix Subtitle Downloader: No update needed - same blob content")}else console.log("Netflix Subtitle Downloader: No cached blob available for injection")}else console.log("Netflix Subtitle Downloader: No cached tracks available for injection")}else console.log("Netflix Subtitle Downloader: No video element or movie ID available for injection"),c&&(console.log("Netflix Subtitle Downloader: Cleaning up subtitle injection"),x())}async function E(e){if(console.log("Smart Netflix Subtitles: Processing subtitles with settings:",e),!i)throw new Error("No current movie ID available");const o=`${i}_${e.targetLanguage}_${e.vocabularyLevel}`;if(f.has(o)){console.log("Smart Netflix Subtitles: Using cached processed subtitles");const t=f.get(o),n=new Blob([t],{type:"text/vtt"}),l=document.querySelector("video");return void(l&&(v(l,n,e.targetLanguage),console.log("Smart Netflix Subtitles: Cached processed subtitles injected successfully")))}g=!0,u=!0,d=e,console.log("Smart Netflix Subtitles: Updated state - enabled:",u,"settings:",d);try{const o=r.get(i);if(!o||0===o.length)throw new Error("No subtitle tracks available");const n=o.find(t=>t.language===e.targetLanguage),l=o.find(t=>t.language===e.nativeLanguage);if(!n)throw new Error(`Target language ${e.targetLanguage} not available`);if(!l)throw new Error(`Native language ${e.nativeLanguage} not available`);setTimeout(()=>{const t=document.querySelector("video");t&&(v(t,new Blob(["WEBVTT\n\n00:00:00.000 --\x3e 01:00:00.000\nLoading smart subtitles..."],{type:"text/vtt"}),e.targetLanguage,!0),console.log("Smart Netflix Subtitles: Loading message displayed (with delay)"))},1500),console.log("Smart Netflix Subtitles: Found tracks:",{targetTrack:n,nativeTrack:l});const a=await L(n),s=await L(l);console.log("Smart Netflix Subtitles: Sending to Railway API...");const c=await t.processSubtitles(a,s,e);if(!c.success||!c.output_srt)throw new Error(c.error||"API processing failed");{console.log("Smart Netflix Subtitles: API processing successful");const t=`${i}-${e.targetLanguage}-${e.nativeLanguage}-${e.vocabularyLevel}`;f.set(t,c.output_srt);const o=N(c.output_srt),n=new Blob([o],{type:"text/vtt"}),l=document.querySelector("video");l&&(v(l,n,e.targetLanguage),console.log("Smart Netflix Subtitles: Processed subtitles injected successfully - loading message replaced")),h({type:"NETFLIX_SUBTITLES",action:"SMART_SUBTITLES_SUCCESS",data:{stats:c.stats,message:"Smart subtitles processed successfully"}})}}catch(t){console.error("Smart Netflix Subtitles: Processing failed:",t),console.log("Smart Netflix Subtitles: Falling back to original subtitles"),u=!1;const o=document.querySelector("video");if(o&&i){const t=r.get(i);if(t&&t.length>0){const n=t.find(t=>t.language===e.targetLanguage);if(n){const t=N(await L(n));v(o,new Blob([t],{type:"text/vtt"}),e.targetLanguage),console.log("Smart Netflix Subtitles: Original subtitles restored - loading message replaced")}}}h({type:"NETFLIX_SUBTITLES",action:"SMART_SUBTITLES_ERROR",data:{error:t instanceof Error?t.message:"Unknown error",message:"Falling back to original subtitles"}})}finally{g=!1}}async function L(e){const t=i+"/"+e.id;if(!a.has(t)){console.log("Smart Netflix Subtitles: Fetching WebVTT from:",e.bestUrl);const o=await fetch(e.bestUrl);if(!o.ok)throw new Error("Failed to fetch WebVTT file");const n=await o.blob();a.set(t,n)}const o=a.get(t);return await y(o)}console.log("Netflix Subtitle Downloader: Starting JSON hijacking immediately");const k=JSON.stringify;JSON.stringify=function(t){const o=S(t);return o&&(console.log("Netflix Subtitle Downloader: Injecting WebVTT format into request"),o.unshift(e)),k.apply(this,arguments)};const I=JSON.parse;JSON.parse=function(){const e=I.apply(this,arguments);if(e&&e.result&&e.result.movieId&&e.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured Netflix API response"),b(e.result)),e&&e.result&&e.result.result&&e.result.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured alternative Netflix API response"),b(e.result.result)),e&&e.result&&e.result.movies)for(const t in e.result.movies){const o=e.result.movies[t];o&&o.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured movies object response"),b(o))}return e},window.addEventListener("message",function(e){if("NETFLIX_SUBTITLES_REQUEST"===e.data.type)switch(console.log("Netflix Subtitle Downloader: Received request from content script:",e.data),e.data.action){case"GET_TRACKS":i&&r.has(i)?h({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:i,tracks:r.get(i)}}):h({type:"NETFLIX_SUBTITLES",action:"NO_TRACKS",data:{message:"No tracks available"}});break;case"DOWNLOAD_SUBTITLE":(async function(e){if(console.log("Netflix Subtitle Downloader: Downloading subtitle for track:",e),!i)throw new Error("No current movie ID");const t=r.get(i);if(!t)throw new Error("No track list found for current movie");const o=t.find(t=>t.id===e);if(!o)throw new Error("Track not found");const n=i+"/"+e;if(!a.has(n)){console.log("Netflix Subtitle Downloader: Fetching WebVTT from:",o.bestUrl);try{const e=await fetch(o.bestUrl);if(!e.ok)throw new Error("Failed to fetch WebVTT file");const t=await e.blob();a.set(n,t),console.log("Netflix Subtitle Downloader: WebVTT cached successfully")}catch(e){throw console.error("Netflix Subtitle Downloader: Error fetching WebVTT:",e),e}}const l=a.get(n),s=await y(l);let c="netflix_subtitle";i&&(c+="_"+i),c+="_"+o.language+".srt";const u=new Blob([s],{type:"text/srt"}),d=URL.createObjectURL(u),g=document.createElement("a");return g.href=d,g.download=c,g.style.display="none",document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(d),console.log("Netflix Subtitle Downloader: Subtitle downloaded:",c),c})(e.data.data.trackId).then(e=>{h({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_SUCCESS",data:{filename:e}})}).catch(e=>{console.error("Netflix Subtitle Downloader: Download error:",e),h({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_ERROR",data:{error:e instanceof Error?e.message:"Unknown error"}})});break;case"processSmartSubtitles":e.data.settings?E(e.data.settings).then(()=>{console.log("Smart Netflix Subtitles: Processing completed successfully")}).catch(e=>{console.error("Smart Netflix Subtitles: Processing failed:",e)}):(console.error("Smart Netflix Subtitles: No settings provided"),h({type:"NETFLIX_SUBTITLES",action:"SMART_SUBTITLES_ERROR",data:{error:"No settings provided"}}))}});let D=null;setInterval(function(){let e=null;const t=document.querySelector("*[data-videoid]");if(t){const o=t.getAttribute("data-videoid");o&&(e=+o)}e!==D&&(console.log("Netflix Subtitle Downloader: Movie ID changed from",D,"to",e),D=e,i=e,s=null,g=!1,f.clear(),u=!1,d=null,T())},500),T(),console.log("Netflix Subtitle Downloader: Page script initialized - JSON hijacking and subtitle injection active (event-driven)")}()})();